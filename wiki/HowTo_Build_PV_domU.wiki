#summary 制作最小pv domU

= 基于ttylinux制作pv domU =

=== 目的 ===
制作一个编译大家测试使用的pv domU(很多朋友没有支持vt的处理器，所以我们主要使用pv domU）
----
 # 感谢我们的镜像提供者——ttylinux ：这是一个广泛应用于嵌入系统的小linux镜像，我们衷心感谢 Douglas Jerome（douglas@ttylinux.org）的无私奉献<br>
 # 感谢stacklet提供Paravirtualized Kernel for Xen : 
----
=== 制作方法 ===
 * 制作一个32M的镜像系统
   # dd if=/dev/zero of=domU-32bit-FS.img bs=1M count=32
   # mkfs.ext3 domU-32bit-FS.img
 * 制作文件系统 —— 我们使用ttylinux-i486-8.0.img作为base文件系统
   # sudo mount -o loop /mnt ttylinux-i486-8.0.img 
   # mkdir domUdisk
   # sudo mount -o loop domU-32bit-FS.img domUdisk
   # cp -a mnt/* domUdisk/ -rf
 * 加入pv kernel 到domU-32bit-FS.img —— 我们使用 linux-2.6.35.8-xenU.x86.tar.bz2 版本的pv kernel
   # tar xf linux-2.6.35.8-xenU.x86.tar.bz2  （从http://stacklet.com/download/kernel/list?architecture=x86下载,可能需要先注册）
   # cp boot/* domUdisk/ -rf
   # cp lib/*  domUdisk/ -rf
 * 修改文件系统的相关配置 —— 见 http://stacklet.com/doc/kernel/howto-deploy-xen-domu-kernel （稍有修改）
   # mkdir domUdisk/boot
   # mkdir domUdisk/boot/grub
   # 修改/boot/grub/grub.conf
   {{{
     title vmlinuz-2.6.35.4
     root (hd0,0)
     kernel /boot/vmlinuz-2.6.35.4 console=hvc0 root=/dev/xvda1 ro 
     写入domUdisk/boot/grub.conf
   }}}
   # 修改/etc/fstab
     {{{
     /dev/xvda1   /           ext3     defaults,errors=remount-ro 0 0
     tmpfs        /dev        tmpfs    noauto                     0 0
     proc         /proc       proc     noauto                     0 0
     none 	  /proc/xen   xenfs   defaults                    0 0
     写入domUdisk/etc/fstab
     }}} 
   # 修改/etc/inittab 
     {{{
     hvc0:2345:respawn:/sbin/getty 38400 hvc0 （可去掉tty相关记录了）
     写入domUdisk/etc/inittab
     }}}
   # 修改/etc/securetty
     {{{
     hvc0
     写入/etc/securetty最后 （可去掉tty相关记录）
     }}}
 * 保存镜像
    umount domUdisk
 * 创建虚拟机启动配置 - pygrub.conf
   {{{
     memory = 512
     name = "ttylinux"
     bootloader = "/usr/bin/pygrub"
     disk = ['tap2:aio:/home/kanghua/xen/domU-32bit-FS.img,xvda1,w'] 
     写入 pygrub.conf 
   }}}
   注意：
   # /home/kanghua/xen/ 请替换为domU-32bit-FS.img的存储路径
   # 网络，cpu等信息非必要信息，需要时自己补充。 

 * 启动虚拟机
   sudo xm cr pygrub.con
 * login虚拟机
  sudo xm console ttylinux (或者vmid)
  {{{
    注：
    1.登陆名root,登陆密码password
    2.如果登陆失败，请查看/var/log/syslog 日志和 /var/log/xen/xend.log 分析原因
  }}}


上述需要文件，都已经上传到 http://code.google.com/p/cloudxy/downloads/


===问题===
 # ttylinux 为了减少体积，使用busybox代替很多执行命令。但busybox有些地方和我们常用的执行命令有区别，请大家使用时注意（尤其写shell脚本时注意）。
 # 你会发现hwclock执行错误，具体原因大概内核支持问题，有兴趣你可调查并解决之。
 # 已经支持xenbus等，可操作/proc/xen/xenbus
 # 该img主要目的是便于大家实验，因此功能难免有所不足。
 # 抛砖引玉，制作pv domU方法很多，请理解为主，不要拘泥。
 # 我们使用blktap2驱动vxda1,最好使用xen4.0以上的版本啦。

---
wroten by 康华
 
#summary HLFS在Libvirt中使用

= 简介 =
===Libvirt 存储管理分为两种模式===
 # 在线模式 -- 应用作为一个服务在运行，例如模拟的块设备等等。
 # 离线模式 -- 即standalone方式运行，应用执行完就退出。

===在线模式===
 * 通过Libvirt创建虚拟机和HLFS格式的磁盘（目前HLFS支持QEMU和XEN）。
 * 通过Libvirt和虚拟机交互，进而通过虚拟机对HLFS格式磁盘进行一些必要的操作。

===离线模式===
 * 通过Libvirt创建HLFS格式的Pool。
 * 通过Libvirt在Pool上创建HLFS格式的Volumes。
 * 通过Libvirt对HLFS Pool和HLFS Volumes进行一些必要的操作。

=在线模式测试=
===测试环境搭建===
 * 搭建HLFS环境，详见http://code.google.com/p/cloudxy/wiki/HlfsUserManual
 * 搭建QEMU环境，详见http://code.google.com/p/cloudxy/wiki/HLFS_SUPPORT_QEMU
 * 搭建Libvirt环境
{{{
  1. git clone git://libvirt.org/libvirt.git
  2. git reset --hard v1.0.1
  3. wget http://cloudxy.googlecode.com/svn/branches/hlfs/person/harry/hlfs/patches/hlfs_driver_for_libvirt_network_disk.patch
  4. git apply hlfs_driver_for_libvirt_network_disk.patch
  5. ./autogen.sh
  6. ./configure
  7. make
  8. sudo make install
注意：HLFS driver for Libvirt network disk 是针对Libvirt v1.0.1
}}} 
 * 搭建环境过程中可能需要安装一些依赖库，缺什么库文件，就安装对应库文件
===从HLFS Volumes启动虚拟机===
 # wget http://wiki.qemu.org/download/linux-0.2.img.bz2
 # bunzip2 linux-0.2.img.bz2
 # mkdir /tmp/testenv
 # qemu-img convert -t directsync linux-0.2.img hlfs:local:///tmp/testenv/testfs
 # cat > hlfs.xml
{{{
<domain type='qemu'>
<name>testvm</name>
<memory>1048576</memory>
<os>
<type arch='x86_64'>hvm</type>
</os>
<devices>
<disk type='network'>
<source protocol="hlfs" name="local:///tmp/testenv/testfs"/>
<target dev='hda' bus='ide'/>
</disk>
<graphics type='vnc' port='-1' autoport='yes'/>
</devices>
</domain> 
}}}
 # virsh create hlfs.xml
 # vncviewer localhost
===从HLFS 快照启动虚拟机===
 # wget http://wiki.qemu.org/download/linux-0.2.img.bz2
 # bunzip2 linux-0.2.img.bz2
 # mkdir /tmp/testenv
 # qemu-img convert -t directsync linux-0.2.img hlfs:local:///tmp/testenv/testfs
 # qemu-img snapshot -c snapshot1 hlfs:local:///tmp/testenv/testfs
 # cat > hlfs.xml
{{{
<domain type='qemu'>
<name>testvm</name>
<memory>1048576</memory>
<os>
<type arch='x86_64'>hvm</type>
</os>
<devices>
<disk type='network'>
<source protocol="hlfs" name="local:///tmp/testenv/testfs%snapshot1"/>
<target dev='hda' bus='ide'/>
</disk>
<graphics type='vnc' port='-1' autoport='yes'/>
</devices>
</domain> 
}}}
 # virsh create hlfs.xml
 # vncviewer localhost
=离线模式测试=
=...待续=
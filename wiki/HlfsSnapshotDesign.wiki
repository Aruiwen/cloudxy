#summary HLFS快照设计.
=HLFS snapshot design=                                     

==主要概念说明==
  * 为什么需要快照
  Hosting服务中数据污染（如网站被黑）时,很需要能回滚到已知最近的正常状态.满足这种回滚到某个状态的要求就是快照的目的.
  * 快照的类型
  我们将快照分为两种类型：
  #checkpoint：检查点，检查点可以简单的认为是自动快照，也就是说无需外部触发，周期性，或者按某种条件自动触发进行的.在我们hlfs目前写透方式下，其实每写入log就等于进一个checkpoint.这种类型的快照无需重新设计，每个log都是一个天然的检查点.
  #snapshot  ：快照,即用户使用接口运行时创建检查点.这种类型的快照是由用户触发,希望能永久性保留.
  * snapshot的内容
  对应inode存储地址、时间戳、以及用户定义的快照名.
  * snapshot的存储方式
  存储在文件checkpoints.txt中,主要追加方式写入.

==关于snapshot场景下的段回收机制设计==
 # 方案1 - 保留最新时期所有日志.
 该方案我们不再区分checkpoint或者snapshot——snapshot的意义相比checkpoint仅仅多了一个用户给定的标记。对段回收任务来说，只关心旧日志距当前多久。超过给定期限则进行回收（回收方法使用后面描述的“区间回收”），否则保留它。


==API设计==
{{{
 int take_snapshot(HLFS_CTRL *ctrl, const char *ssname)
  给用户提供的在线方式快照接口，用户可以指定快照名
  * ctrl: 全局控制结构体
  * ssname: 用户指定的快照名
  * return value: 成功返回0，失败返回<0
 int rm_snapshot(const char *uri, const char *ssname)
  用户可以通过这个接口来删除指定名字的快照
  * uri: 文件系统的位置 
  * ssname: 用户指定的快照名
  * return value: 成功返回0，失败返回<0
 int find_inode_before_time(const char *uri, uint64_t time,uint64_t* inode_addr)
  用户可以通过这个接口来获取timestamp之前的inode存储地址
  * uri: 文件系统的位置 
  * time: 用户指定的时间
  * inode_addr 返回inode存储地址。
  * return value: 成功返回0,失败返回<0
 int find_inode_by_name(const char *uri, const char *ssname,uint64_t* inode_addr)
  用户可以通过这个接口来获取指定名字的快照记录的inode存储地址
  * uri: 文件系统的位置 
  * ssname: 用户指定的快照名
  * inode_addr 返回inode存储地址
  * return value: 成功返回0,失败返回<0
 int get_inode_info(const char *uri,uint64_t inode_addr, uint64_t *creat_time, uint64_t *length)
  获取指定inode的创建时间和文件长度
  * uri: 文件系统的位置 
  * inode_addr: 指定的inode存储地址
  * creat_time: 创建时间将存放在这里
  * length: 文件长度将存放在这里
  * return value: 成功返回0，失败返回<0
 int hlfs_open_by_inode(HLFS_CTRL *ctrl,uint64_t inode_addr,int flag)
  加载指定的inode，以flag标识的模式启动回滚
  * ctrl : 全局控制结构
  * inode: 指定的inode
  * flag: 0 只读模式， 1 可写模式
  * return value: 成功返回0，失败返回<0
 int list_all_snapshot(const char *uri，char* ss_name_array)
  给用户列出所有已存在的快照名及时间信息
  * uri: 文件系统的位置 
  * ss_name_arrary: 返回的快照名字列表
  * return value: 成功返回0，失败返回<0
}}}
==API使用指南==
  * 快照： 在线模式调用take_snapshot()函数
  * 获取快照清单：离线模式调用list_all_snapshot()
  * 删除指定名字的快照：离线模式调用rm_snapshot()
  * 回滚到检查点：调用find_inode_before_time获得inode结构体，然后调用get_inode_info()获取inode信息，根据该信息判断是否满足用户要求，则启动回滚——调用init_hlfs()获得全局控制结构，并以只读或者是可写模式调用hlfs_open_by_inode()
  * 回滚到快照：调用find_inode_by_name获得inode结构体，启动回滚——调用init_hlfs()获得全局控制结构，并以只读或者是可写模式调用hlfs_open_by_inode()
#summary HLFS在QEMU中使用

= 简介 =
我们已经将HLFS移植到QEMU环境下，从而支持在KVM等虚拟环境下使用其。


= 下载和编译 =
  # 下载 qemu - git clone git://git.qemu.org/qemu.git
  # 下载patch for qemu - https://cloudxy.googlecode.com/svn/trunk/hlfs/patches/hlfs_driver_for_qemu.patch
  # patch it - 在qemu目录外执行 ：patch -p0< hlfs_driver_for_qemu.patch
{{{
修改configure中
GLIB_DIR1_INC=/usr/lib/glib-2.0/include
GLIB_DIR2_INC=/usr/include/glib-2.0
HLFS_DIR=/home/kanghua/workshop3.bak/hlfs
JVM_DIR=/usr/lib/jvm/java-6-sun/
几个变量位置为你环境的实际地址
}}}
  # 编译 cd qemu;./configure;make - 生成qemu-img
{{{
ldd ./qemu-img 查看是否其指向的库都存在！
}}}
= 支持操作 =
{{{
注意：
1.目前尚不支持prealloc操作
2.确保ldd ./qemu-img 所显示的库(hlfs,hdfs,jvm,log4c等）处于动态库搜索路径，如果不再，则要自己手动添加到路径中。
}}}
  * 创建网络磁盘操作
{{{
./qemu-img create hlfs:local:///tmp/testenv/testfs 10G 或
./qemu-img create hlfs:hdfs:///tmp/testenv/testfs 10G
}}}
  * 状态查询
{{{
./qemu-img info hlfs:local:///tmp/testenv/testfs 或
./qemu-img info hlfs:hdfs:///tmp/testenv/testf 
}}}
  * 快照相关操作
{{{
生成快照
./qemu-img snapshot -c snapshot1 hlfs:local:///tmp/testenv/testfs 或
./qemu-img snapshot -c snapshot1 hlfs:hdfs:///tmp/testenv/testfs
查询快照
./qemu-img snapshot -l hlfs:local:///tmp/testenv/testfs 或
./qemu-img snapshot -l hdfs:local:///tmp/testenv/testfs
删除快照
./qemu-img snapshot -d snapshot1 hlfs:local:///tmp/testenv/testfs 或
./qemu-img snapshot -d snapshot1 hlfs:hdfs:///tmp/testenv/testfs
}}}
  * 格式转换操作
{{{
./qemu-img convert raw.img  hlfs:local:///tmp/testenv/testfs
}}}
  * 格式转换操作
{{{
./qemu-img convert raw.img  hlfs:local:///tmp/testenv/testfs 或
./qemu-img convert raw.img  hlfs:hdfs:///tmp/testenv/testfs
}}}
  * KVM启动
{{{
qemu-system-x86_64 -enable-kvm -m 1024 -smp 2 -drive file=hlfs:local:///tmp/testenv/testfs,if=virtio -boot d -vnc :7 或 
qemu-system-x86_64 -enable-kvm -m 1024 -smp 2 -drive file=hlfs:hdfs:///tmp/testenv/testfs,if=virtio -boot d -vnc :7
从某个快照上启动
qemu-system-x86_64 -enable-kvm -m 1024 -smp 2 -drive file=hlfs:local:///tmp/testenv/testfs%snapshot1,if=virtio -boot d -vnc :7 或 
qemu-system-x86_64 -enable-kvm -m 1024 -smp 2 -drive file=hlfs:hdfs:///tmp/testenv/testfs%shopshot1,if=virtio -boot d -vnc :7
%后为快照名称
}}}
 * Clone 操作
{{{
1.首先给base hlfs系统打个快照 - ./qemu-img snapshot -c snapshot1 hlfs:local:///tmp/testenv/testfs
2.创建新的hlfs系统 - ./qemu-img create hlfs:local:///tmp/testenv/testfs2 10G
3.执行clone操作 -./qemu-img snapshot -b local:///tmp/testenv/testfs%snapshot1 hlfs:local:///tmp/testenv/testfs2 （快照和base系统之间使用%区分！）
4.试试看hlfs:local:///tmp/testenv/testfs2啦。
--------------------------------------------
不用qemu的情况下，在我们outpub/bin下也有快照和clone命令，类似用法为
./output/bin/snapshot.hlfs -u local:///tmp/testenv/testfs -s snapshot1
./output/bin/clone.hlfs -f local:///tmp/testenv/testfs%snapshot1 -s local:///tmp/testenv/testfs2 
--------------------------------------------
CLONE行为用在那里？ 
A 一个hdfs之上的镜像，可以作为无数新系统的base磁盘，从而提高系统生产速度和解决存储空间。
B 为了减少本网络传输压力，提高系统响应速度，可考虑利用本地文件系统作为Base数据宿主：比如一些场景中——我们可以将标准的镜像或某系通用软件做到工具盘中，并置于到本地hlfs上,即local方式挂载的hlfs系统上，然后再在集群的hdfs上做一个新hlfs系统，并将其base到本地上述hlfs上。从而只有变化的增量数据需要途径网络io，这样很大程度上会提高系统性能。

}}}

